<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.example.transaction.dao.CommodityDAO">
    <!--查询与account关联的所有信息，如commodityList、notice、commodityImages-->
    <resultMap id="commodityInfo" type="commodity">
        <id property="id" column="id"/>
        <association property="notice" javaType="com.example.transaction.pojo.Notice" column="notice_id" select="com.example.transaction.dao.NoticeDAO.getCreditByNoticeId"/>
        <collection property="types" ofType="com.example.transaction.pojo.Type" column="id" select="com.example.transaction.dao.TypeDAO.getAllTypeByCommodityId"/>
        <collection property="commodityImages" ofType="com.example.transaction.pojo.CommodityImage" column="id" select="com.example.transaction.dao.CommodityImageDAO.getAllImageByCommodityId"/>
        <collection property="reservation" ofType="com.example.transaction.pojo.Reservation" column="id" select="com.example.transaction.dao.ReservationDAO.getAllReservationByCommodityId"/>
    </resultMap>

    <select id="selectWithCondition" resultMap="commodityInfo" resultType="com.example.transaction.pojo.Commodity">
        select * from commodity ${ew.customSqlSegment}
    </select>

    <!--分页查询-->
    <select id="selectCommodityPage" resultMap="commodityInfo" resultType="com.example.transaction.pojo.Commodity">
        select * from commodity ${ew.customSqlSegment}
    </select>

    <!--商品名模糊分页查询，新旧程度排序-->
    <select id="sortByNewness" resultMap="commodityInfo" resultType="com.example.transaction.pojo.Commodity">
        select * from commodity c, notice n where c.name like concat('%',#{name},'%') and c.notice_id = n.id and n.end_time &gt;= #{timestamp} order by c.newness Desc, c.expected_price ASC
    </select>
    <!--商品类型分页查询-->
    <select id="sortByType" resultMap="commodityInfo" resultType="com.example.transaction.pojo.Commodity">
        select * from commodity c, notice n, `type` t where c.id = t.commodity_id and c.notice_id = n.id and n.end_time &gt;= #{timestamp} and t.id = #{typeId}
    </select>
    <!--商品价格区间分页查询-->
    <select id="betweenPrice" resultMap="commodityInfo" resultType="com.example.transaction.pojo.Commodity">
        select * from commodity c, notice n where c.name like concat('%',#{name},'%') and  c.expected_price between #{low} and #{high} and c.notice_id = n.id and n.end_time &gt;= #{timestamp}
    </select>
    <!--商品名模糊分页查询, 所有者信誉排序-->
    <select id="sortByCredit" resultMap="commodityInfo" resultType="com.example.transaction.pojo.Commodity">
        select * from commodity c, notice n, account a, estimate e where n.account_id = a.id and c.name like concat('%',#{name},'%') and c.notice_id = n.id and e.account_id = a.id and n.end_time &gt;= #{timestamp} order by (e.purchase_credit + e.sell_credit) DESC, c.expected_price ASC
    </select>
</mapper>
